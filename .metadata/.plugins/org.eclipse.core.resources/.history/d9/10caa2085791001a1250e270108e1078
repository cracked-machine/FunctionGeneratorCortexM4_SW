/*
 * EventManager.c
 *
 *  Created on: May 8, 2020
 *      Author: chris
 */


#include "EventManager.h"
#include "DisplayManager.h"

#include "dac.h"

#include <stdio.h>

#include "pysine.h"
#include "pysquare.h"
#include "pyunitimpulse.h"
#include "pysaw.h"
#include "pysaw_rev.h"
#include "pytriangle.h"

// public function prototypes
void EM_SetNewEvent(eSystemEvent pEvent);
eOutput_mode EM_GetOutputMode();

// private function prototypes
void _ClearEvent();
eSystemState _FuncMenuHandler(void);
eSystemState _FreqMenuHandler(void);
eSystemState _AmplMenuHandler(void);
eSystemState _BiasMenuHandler(void);
eSystemState _AdjustConfirmedHandler(void);

// state machine
eSystemState eNextState = Idle_State;
eSystemEvent eNewEvent;

// function output mode
eOutput_mode eNewOutMode = Sine_Out_Mode;

// rotary encoder value
uint32_t newRotEncoderValue = 0;
uint32_t oldRotEncoderValue = 0;

/*
 *
 * 	Main state machine for event process
 *
 */
void EM_ProcessEvent()
{

	switch(eNextState)
	{
		case Idle_State:
			if(eNewEvent == evFuncMenu)
			{
				eNextState = _FuncMenuHandler();
			}
			if(eNewEvent == evFreqMenu)
			{
				eNextState = _FreqMenuHandler();
			}
			if(eNewEvent == evAmplMenu)
			{
				eNextState = _AmplMenuHandler();
			}
			if(eNewEvent == evBiasMenu)
			{
				eNextState = _BiasMenuHandler();
			}
			if(eNewEvent == evAdjustConfirmed)
			{
				eNextState = _AdjustConfirmedHandler();
			}
			break;

		case Func_Menu_State:
			if(eNewEvent == evEncoderSet)
			{
				eNextState = _FuncSetHandler();
			}
		default:
			break;
	}

}

///////////////////////////////////////////////////////
//////		PRIVATE EVENTHANDLER FUNCTIONS		///////
///////////////////////////////////////////////////////

/*
 *
 *	Business logic for evFunctionMenu events
 *
 */
eSystemState _FuncMenuHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("FunctionMenu Event captured\n");
#endif

	DM_ShowFuncSelectMenu(1);

	//HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
	//HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, triangle_data_table, SINE_DATA_SIZE, DAC_ALIGN_12B_R);
	//_ClearEvent();

	return Func_Menu_State;
}

/*
 *
 *	Business logic for evFunctionSet events
 *
 */
eSystemState _FuncSetHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("FunctionAdjust Event captured\n");
#endif
	if(newRotEncoderValue > oldRotEncoderValue)
	{

	}
	else
	{

	}
	oldRotEncoderValue = newRotEncoderValue;
	return Func_Menu_State;
}


/*
 *
 *	Business logic for FreqAdjust events
 *
 */
eSystemState _FreqMenuHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("FreqMenu Event captured\n");
#endif
	_ClearEvent();
	return Idle_State;
}

/*
 *
 *	Business logic for AmplitudeAdjust events
 *
 */
eSystemState _AmplMenuHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("AmplitudeMenu Event captured\n");
#endif
	_ClearEvent();
	return Idle_State;
}

/*
 *
 *	Business logic for BiasAdjust events
 *
 */
eSystemState _BiasMenuHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("BiasMenu Event captured\n");
#endif
	_ClearEvent();
	return Idle_State;
}

/*
 *
 *	Business logic for AdjustConfirmed events
 *
 */
eSystemState _AdjustConfirmedHandler(void)
{
#ifdef EM_SWV_DEBUG
	printf("AdjustConfirmed Event captured\n");
#endif
	_ClearEvent();
	return Idle_State;
}


/*
 *
 * 	Set by NVIC interrupt handlers
 *
 */
void EM_SetNewEvent(eSystemEvent pEvent)
{
	eNewEvent = pEvent;
}

/*
 *
 * Reset the eNewEvent member back to idle
 *
 */
void _ClearEvent()
{
	eNewEvent = evIdle;
}

/*
 *
 *
 *
 */
eOutput_mode EM_GetOutputMode()
{
	return eNewOutMode;
}

/*
 *
 *
 *
 */
eSystemState EM_GetSystemState()
{
	return eNextState;
}

/*
 *
 *
 *
 */
void EM_SetEncoderValue(uint32_t pValue)
{
	newRotEncoderValue = pValue;


}
