/*
 * FunctionOutput.c
 *
 *  Created on: 9 May 2020
 *      Author: chris
 */


#include "FunctionOutput.h"
#include "EventManager.h"

#include "dac.h"
#include "tim.h"

#include "pysine.h"
#include "pysquare.h"
#include "pyunitimpulse.h"
#include "pysaw.h"
#include "pysaw_rev.h"
#include "pytriangle.h"

#include "SignalManager.h"

uint8_t FuncPresetEncoderRange = 20;

/*
 *	Array of objects for Function Presets and their encoder positions for func preset menu
 */
Func_Preset_Encoder_Pos_t aFuncPresetEncoderPos[MAX_NUM_FUNC_PRESETS] =
{
	{ Sine_Out_Mode,		20 },
	{ Square_Out_Mode,		16 },
	{ Saw_Out_Mode,			12 },
	{ RevSaw_Out_Mode,		8 },
	{ Triangle_Out_Mode, 	4 },
	{ Impulse_Out_Mode, 	0 }

};


eOutput_mode FO_GetOutputMode();
//void FuncO_SetOutputMode(eOutput_mode pNewMode);

// signal output function
eOutput_mode eNewOutMode = Sine_Out_Mode;

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void FuncO_ModifyOutput(uint16_t pEncoderValue)
{


	switch(pEncoderValue)
	{
		case 0:
		case 1:
		case 2:

			FuncO_ApplyPreset_Fast(Sine_Out_Mode);
			break;
		case 3:
		case 4:
		case 5:
		case 6:

			FuncO_ApplyPreset_Fast(Square_Out_Mode);

			break;
		case 7:
		case 8:
		case 9:
		case 10:

			FuncO_ApplyPreset_Fast(Saw_Out_Mode);
			break;
		case 11:
		case 12:
		case 13:
		case 14:

			FuncO_ApplyPreset_Fast(RevSaw_Out_Mode);
			break;
		case 15:
		case 16:
		case 17:
		case 18:

			FuncO_ApplyPreset_Fast(Triangle_Out_Mode);
			break;
		case 19:
		case 20:
		case 21:
		case 22:
		case 23:

			FuncO_ApplyPreset_Fast(Impulse_Out_Mode);
			break;
	}
}

/*
 *
 *	@brief	Set function output preset by index
 *
 *	@param pPresetEnum the enum literal for the preset. Should be one of the following:
 *
 *

 *	@retval None
 *
 */
void FuncO_ApplyPreset_Fast(eOutput_mode pPresetEnum)
{

	switch(pPresetEnum)
	{
		case Sine_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[0];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, sine_data_table, SINE_DATA_SIZE, DAC_ALIGN_12B_R);
			break;

		case Square_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[1];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, square_data_table, SQUARE_DATA_SIZE, DAC_ALIGN_12B_R);
			break;

		case Saw_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[2];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, saw_data_table, SAW_DATA_SIZE, DAC_ALIGN_12B_R);
			break;

		case RevSaw_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[3];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, saw_rev_data_table, SAW_REV_DATA_SIZE, DAC_ALIGN_12B_R);
			break;

		case Triangle_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[4];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, triangle_data_table, TRIANGLE_DATA_SIZE, DAC_ALIGN_12B_R);
			break;

		case Impulse_Out_Mode:
			pNewFuncPresetEncoderPos = &aFuncPresetEncoderPos[5];
			HAL_DAC_Stop_DMA(&hdac1, DAC1_CHANNEL_1);
			HAL_DAC_Start_DMA(&hdac1, DAC1_CHANNEL_1, unitimpulse_data_table, UNITIMPULSE_DATA_SIZE,  DAC_ALIGN_12B_R);
			break;

	//
	}

}

/*
 *
 *	@brief Set function output preset by search
 *
 *	@param pPresetEnum search criteria. Should be one of the following:
 *
 *

 *	@retval None
 *
 */
void FuncO_ApplyPreset(eOutput_mode pPresetEnum)
{
	Func_Preset_Encoder_Pos_t * tmp = Func_FindFPresetObject(pPresetEnum);
	if(tmp)
	{

	}
}

/*
 *
 *	@brief Get currently set function output preset
 *
 *	@param None
 *	@retval pointer to Func_Preset_Encoder_Pos_t struct
 *
 */
Func_Preset_Encoder_Pos_t * FuncO_GetFPresetObject()
{
	return pNewFuncPresetEncoderPos;
}


/*
 *
 *	@brief Search array of preset structs
 *
 *	@param Search criteria. Should be one of the following:
 *
 *	Sine_Out_Mode,
	Square_Out_Mode,
	Saw_Out_Mode,
	RevSaw_Out_Mode,
	Triangle_Out_Mode,
	Impulse_Out_Mode

 *	@retval pointer to Func_Preset_Encoder_Pos_t struct
 *
 */
Func_Preset_Encoder_Pos_t * FuncO_FindFPresetObject(eOutput_mode pEnum)
{
	for(int i = 0; i < MAX_NUM_FUNC_PRESETS; i++ )
	{
		if(aFuncPresetEncoderPos[i].func == pEnum)
		{
			return &aFuncPresetEncoderPos[i];
		}
	}
	// error!
	return 0;
}


/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void FuncO_SetOutputMode(eOutput_mode pNewMode)
{
	eNewOutMode = pNewMode;
}


/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
eOutput_mode FuncO_GetOutputMode()
{
	return eNewOutMode;
}

/*
 *
 *	@brief	Get range value for rotary encoder
 *
 *	@param None
 *	@retval uint8_t
 *
 */
uint8_t FuncO_GetFuncPresetEncoderRange()
{
	return FuncPresetEncoderRange;
}



