/*
 * GainOutput.c
 *
 *  Created on: 9 May 2020
 *      Author: chris
 */

#include "GainOutput.h"

#include "gpio.h"
#include "tim.h"

#include "SignalManager.h"



int8_t gain_decibels[8] = { -1, 0, 6, 9, 12, 14, 16, 18 };

/*
 *	Array of objects for Gain Presets and their encoder positions for gain preset menu
 */
Gain_Preset_Encoder_Pos_t aGainPresetEncoderPos[MAX_NUM_GAIN_PRESETS] =
{
	{ Zero_Gain,	-1, 28 },
	{ One_Gain,		0,  24 },
	{ Two_Gain,		6,  20 },
	{ Three_Gain,	9,  16 },
	{ Four_Gain, 	12, 12 },
	{ Five_Gain, 	14, 8 },
	{ Six_Gain,		16, 4 },
	{ Seven_Gain, 	18, 0 }

};

/*
 * 		eDefaultFreqPreset set by SignalManager
 */
Gain_Preset_Encoder_Pos_t *pNewGainPresetEncoderPos = &aGainPresetEncoderPos[eDefaultGainPreset];


uint8_t GainPresetEncoderRange = 28;


// signal output gain
eOutput_gain eNewOutGain = One_Gain;

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
int8_t GO_GetGainInDecibels(eOutput_gain pGain)
{
	return gain_decibels[pGain];
}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void GO_SetOutputToEncoder(uint8_t pGain)
{

	// PGA Truth table for LTC6910:
	// https://www.analog.com/media/en/technical-documentation/data-sheets/6910fb.pdf
	switch(pGain)
	{
		case 0:
		case 1:
		case 2:
		case 3:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			eNewOutGain = Zero_Gain;
			break;
		case 4:
		case 5:
		case 6:
		case 7:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			eNewOutGain = One_Gain;
			break;
		case 8:
		case 9:
		case 10:
		case 11:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			eNewOutGain = Two_Gain;
			break;
		case 12:
		case 13:
		case 14:
		case 15:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			eNewOutGain = Three_Gain;
			break;
		case 16:
		case 17:
		case 18:
		case 19:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			eNewOutGain = Four_Gain;
			break;
		case 20:
		case 21:
		case 22:
		case 23:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			eNewOutGain = Five_Gain;
			break;
		case 24:
		case 25:
		case 26:
		case 27:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			eNewOutGain = Six_Gain;
			break;
		case 28:
		case 29:
		case 30:
		case 31:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			eNewOutGain = Seven_Gain;
			break;
	}

}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void GO_SetOutputGain(uint8_t pGain, uint8_t reverse)
{
	if(reverse)
	{
		switch(pGain)
		{
			case 7:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Zero_Gain;
				break;
			case 6:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = One_Gain;
				break;
			case 5:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Two_Gain;
				break;
			case 4:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Three_Gain;
				break;
			case 3:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Four_Gain;
				break;
			case 2:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Five_Gain;
				break;
			case 1:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Six_Gain;
				break;
			case 0:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Seven_Gain;
				break;
		}
	}
	else
	{
		switch(pGain)
		{
			case 0:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Zero_Gain;
				break;
			case 1:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = One_Gain;
				break;
			case 2:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Two_Gain;
				break;
			case 3:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
				eNewOutGain = Three_Gain;
				break;
			case 4:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Four_Gain;
				break;
			case 5:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Five_Gain;
				break;
			case 6:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Six_Gain;
				break;
			case 7:
				HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
				HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
				eNewOutGain = Seven_Gain;
				break;
		}
	}

}

void FuncO_ModifyOutput(uint16_t pEncoderValue)
{


	switch(pEncoderValue)
	{
		case 0:
		case 1:
		case 2:
		case 3:
			GO_ApplyPreset_Fast(One_Gain);
			break;
		case 4:
		case 5:
		case 6:
		case 7:
			GO_ApplyPreset_Fast(Two_Gain);
			break;
		case 8:
		case 9:
		case 10:
		case 11:
			GO_ApplyPreset_Fast(Three_Gain);
			break;
		case 12:
		case 13:
		case 14:
		case 15:
			GO_ApplyPreset_Fast(Four_Gain);
			break;
		case 16:
		case 17:
		case 18:
		case 19:
			GO_ApplyPreset_Fast(Five_Gain);
			break;
		case 20:
		case 21:
		case 22:
		case 23:
			GO_ApplyPreset_Fast(Six_Gain);
			break;
		case 24:
		case 25:
		case 26:
		case 27:
			GO_ApplyPreset_Fast(Seven_Gain);
			break;


	}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void GO_ApplyPreset(eOutput_gain pPresetEnum)
{

}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
void GO_ApplyPreset_Fast(eOutput_gain pPresetEnum)
{
	switch(pPresetEnum)
	{
		case Zero_Gain:
			pNewGainPresetEncoderPos = &aGainPresetEncoderPos[0];
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			break;

		case One_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			break;

		case Two_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			break;

		case Three_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_RESET);
			break;

		case Four_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			break;

		case Five_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			break;

		case Six_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_RESET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			break;

		case Seven_Gain:
			HAL_GPIO_WritePin(SG0_GPIO_Port, SG0_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG1_GPIO_Port, SG1_Pin, GPIO_PIN_SET);
			HAL_GPIO_WritePin(SG2_GPIO_Port, SG2_Pin, GPIO_PIN_SET);
			break;
	}
}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
Gain_Preset_Encoder_Pos_t * GO_FindGPresetObject(eOutput_gain pEnum)
{

	for(int i = 0; i < MAX_NUM_GAIN_PRESETS; i++ )
	{
		if(aGainPresetEncoderPos[i].gain == pEnum)
		{
			return &aGainPresetEncoderPos[i];
		}
	}
	// error!
	return 0;
}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
Gain_Preset_Encoder_Pos_t * GO_GetGPresetObject()
{
	return pNewGainPresetEncoderPos;
}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
uint8_t FreqO_GetFreqPresetEncoderRange()
{
	return GainPresetEncoderRange;
}

/*
 *
 *	@brief
 *
 *	@param None
 *	@retval None
 *
 */
uint8_t GO_GetOutputGain()
{
	return (uint8_t)eNewOutGain;
}
